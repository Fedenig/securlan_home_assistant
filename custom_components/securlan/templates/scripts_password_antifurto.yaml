script:
  save_alarm_code:
    alias: "Salva password allarme"
    sequence:
      # 1. Salva la password nel secrets.yaml
      - service: securlan.set_password
        data:
          key: password_allarme
          value: "{{ states('input_text.alarm_code') }}"

      # 2. Pulisci il campo input_text
      - service: input_text.set_value
        target:
          entity_id: input_text.alarm_code
        data:
          value: ""

  get_password:
    alias: Mostra Password Allarme
    sequence:
      - service: securlan.get_password
        data:
          name: password_allarme
      - service: input_text.set_value
        target:
          entity_id: input_text.password_allarme
        data:
          value: ""
          
  get_password_popup:
    alias: "Salva password allarme e mostra popup"
    sequence:
      # 0) memorizza il valore inserito (prima di pulirlo)
      - variables:
          saved_pwd: "{{ states('input_text.alarm_code') }}"

      # 1) salva la password su Securlan
      - service: securlan.set_password
        data:
          key: password_allarme
          value: "{{ saved_pwd }}"

      # 2) pulisci il campo di inserimento (se è la tua logica attuale)
      - service: input_text.set_value
        target:
          entity_id: input_text.alarm_code
        data:
          value: ""

      # 3) prova a far tornare il valore da Securlan nell'entity locale
      #    (5 tentativi, 1s di attesa ciascuno)
      - repeat:
          count: 2
          sequence:
            - service: securlan.get_password
              data:
                name: password_allarme
            - delay: "00:00:01"

      # 4) mostra il popup: stampo sempre il valore salvato (saved_pwd)
      #    e, se presente, mostro anche il valore attualmente letto da input_text.password_allarme
      - service: browser_mod.popup
        data:
          title: "✅ Password Allarme Securlan"
          content:
            type: markdown
            content: |
              **Password salvata (valore inserito):**  
              **{{ saved_pwd if saved_pwd != '' else '— nessun valore inserito —' }}**
          dismissable: true
          autoclose: false
          
